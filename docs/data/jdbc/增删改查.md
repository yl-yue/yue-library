# å¢åˆ æ”¹æŸ¥ï¼ˆCRUDï¼‰
!> ç”±äºåœ¨ [AbstractBaseDAO](data/jdbc/AbstractBaseDAO.md) ä¸­å·²æè¿°äº†`Db`ç±»çš„å¸¸è§„ç”¨æ³•ï¼Œæ‰€ä»¥åœ¨ä¸‹é¢çš„ä»‹ç»ä¸­ï¼Œåªä¸¾ä¾‹é™¤æ­¤ä¹‹å¤–çš„æ›´å¤šæ–¹æ³•å¦‚ä½•ä½¿ç”¨

## `Db`å¯¹è±¡çš„ä½¿ç”¨
`ai.yue.library.data.jdbc.client.Db`ç±»æ˜¯æ‰€æœ‰CRUDæ“ä½œçš„åŸºç¡€ï¼ŒåŒæ—¶ä»–æ˜¯ä¸€ä¸ª**è‡ªåŠ¨è£…é…çš„Bean**ï¼Œå½“æˆ‘ä»¬ç»§æ‰¿`AbstractDAO`ç±»æ—¶ï¼ŒBean`protected Db db`æ—©å·²å£°æ˜åœ¨çˆ¶ç±»ä¸­ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨å½“å‰ç±»ä¸­è°ƒç”¨`Db`ä¸­çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š

```java
@Repository
public class DataJdbcExampleDAO extends AbstractDAO {
public class DataJdbcExampleRepositoryDAO extends AbstractRepository<UserDO> {

...

db.insert(tableName(), paramJson);
db.updateById(tableName(), paramJson);
db.deleteByUuid(tableName(), "uuid");
db.getByUuid(tableName(), "uuid");
db.queryForList("SELECT * FROM table_example", null);
```

`Db`å¯¹è±¡æ˜¯ä¸€ä¸ªè‡ªåŠ¨è£…é…çš„Beanï¼Œå› æ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥é‡‡ç”¨`Autowired`ç­‰Beanæ³¨å…¥å½¢å¼ï¼Œå†Springä¸Šä¸‹æ–‡ä¸­çš„ä»»ä½•åœ°æ–¹ä¸­å¼•ç”¨ä»–ï¼Œå¦‚ä¸‹ï¼š

```java
public class XxxDAO {
public class XxxService {

...

db.insert(tableName(), paramJson);
db.updateById(tableName(), paramJson);
db.deleteByUuid(tableName(), "uuid");
db.getByUuid(tableName(), "uuid");
db.queryForList("SELECT * FROM table_example", null);
```

> `Db`ç±»ä¸­çš„æ‰€æœ‰å®ä½“æ˜ å°„ä¸ç±»å‹è½¬æ¢ï¼Œä½¿ç”¨çš„éƒ½æ˜¯ [Convert](base/ç±»å‹è½¬æ¢å™¨.md) ç±»å‹è½¬æ¢å™¨è¿›è¡Œå®ç°ï¼ŒåŒæ—¶ä»–ä¹Ÿé€‚ç”¨äºå„ç§ä¸šåŠ¡å¤æ‚çš„ç±»å‹è½¬è¡Œåœºæ™¯ã€‚

## å¢
### æ’å…¥æ•°æ®-è‡ªåŠ¨é€’å¢ sort_idx :id=sort_idx
<font color=red>å¯ç”¨äºæ•°æ®éœ€è¦è‡ªå®šä¹‰æ’åºçš„æ’å…¥æ“ä½œï¼Œä½¿ç”¨æ¡ä»¶ï¼š</font>

1. `id` é»˜è®¤ä¸ºä¸»é”®
2. `sort_idx` é»˜è®¤ä¸ºæ’åºå­—æ®µï¼Œç±»å‹ä¸º int unsigned ã€‚DDLç¤ºä¾‹ï¼š`sort_idx` tinyint(2) UNSIGNED NOT NULL COMMENT 'æ’åº-ç´¢å¼•'

```java
/**
 * æ’å…¥æ•°æ®-è‡ªåŠ¨é€’å¢ sort_idx
 * @param paramJson
 * @return
 */
public Long insert(JSONObject paramJson) {
	String uniqueKeys = "name";// å¯é€‰å‚æ•°
	return db.insertWithSortIdxAutoIncrement(tableName(), paramJson, uniqueKeys);
}
```

### æ’å…¥æˆ–æ›´æ–°
å½“æ•°æ®æ“ä½œä¸ç¡®å®šæ—¶å¯æ‰§è¡Œæ­¤æ“ä½œã€‚å»ºè®®æŸäº›ç‰¹æ®Šåœºæ™¯ä½¿ç”¨ï¼Œä¸€èˆ¬ä¸šåŠ¡å¯å…ˆæŸ¥è¯¢åˆ¤æ–­ï¼Œç»™äºˆå‰ç«¯å‹å¥½æç¤ºï¼Œå†æ‰§è¡Œæ’å…¥æ“ä½œ
```java
/**
 * æ’å…¥æˆ–æ›´æ–°
 * @param paramJson
 * @return
 */
public Long insertOrUpdate(JSONObject paramJson) {
	String[] conditions = {"id"};
	return db.insertOrUpdate(tableName(), paramJson, conditions, DBUpdateEnum.æ­£å¸¸);
}
```

## åˆ 
**ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹æ•°æ®è®¢æ­£è§„çº¦ï¼š**

![æ•°æ®è®¢æ­£è§„çº¦](jdbc_files/æ•°æ®è®¢æ­£è§„çº¦.jpg)

### é€šè¿‡è¡¨ä¸­æŸä¸ªå­—æ®µåˆ é™¤å¤šæ¡æ•°æ®
```java
/**
 * åˆ é™¤
 * @param name
 */
public void deleteByName(String name) {
	JSONObject paramJson = new JSONObject();
	paramJson.put("name", name);
	db.delete(tableName(), paramJson);
}
```

### æ‰¹é‡åˆ é™¤æ•°æ®ï¼Œä¸€ç»„æ¡ä»¶å¯¹åº”ä¸€æ¡æ•°æ®ï¼Œå¹¶ä¸”æ¯ç»„æ¡ä»¶éƒ½é‡‡ç”¨ç›¸åŒçš„key
```java
	/**
	 * åˆ é™¤-æ‰¹é‡
	 * @param paramJsons
	 */
	public void deleteBatch(JSONObject[] paramJsons) {
		db.deleteBatch(tableName(), paramJsons);
	}
```

### æ‰¹é‡åˆ é™¤æ•°æ®ï¼ŒæŒ‡å®šSQLè¯­å¥ä»¥åˆ›å»ºé¢„ç¼–è¯‘æ‰§è¡ŒSQLå’Œç»‘å®šåˆ é™¤å‚æ•°
```java
/**
 * åˆ é™¤-æ‰¹é‡
 * @param paramJsons
 */
public void deleteBatch2(JSONObject[] paramJsons) {
	String sql =
			"DELETE \n" +
			"FROM\n" +
			"	table_example \n" +
			"WHERE\n" +
			"	1 = 1 \n" +
			"	AND user_id > :user_id";
	int[] updateRowsNumbers = db.deleteBatch2(sql, paramJsons);
	Console.log(Arrays.toString(updateRowsNumbers));
}
```

## æ”¹
### æ ¹æ®IDæ›´æ–°
```java
/**
 * æ›´æ–°-ById
 * @param paramJson
 */
public void updateById(JSONObject paramJson) {
	db.updateById(tableName(), paramJson, DBUpdateEnum.é€’å‡_æ— ç¬¦å·);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

### æ ¹æ®æ¡ä»¶æ›´æ–°
```java
/**
 * æ›´æ–°-ByName
 * @param paramJson
 */
public void updateByName(JSONObject paramJson) {
	String[] conditions = {"name"};
	long updateRowsNumber = db.update(tableName(), paramJson, conditions);
	int expectedValue = 1;
	db.updateAndExpectedEqual(updateRowsNumber, expectedValue);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

### æ›´æ–°-æ’åº
ä½¿ç”¨é™åˆ¶è§ï¼š [æ’å…¥æ•°æ®-è‡ªåŠ¨é€’å¢ sort_idx](#sort_idx)
```java
/**
 * æ›´æ–°-æ’åº
 * @param id
 * @param move
 */
public void updateSort(Long id, Integer move) {
	String uniqueKeys = "name";
	db.updateSort(tableName(), id, move, uniqueKeys);
}
```

### æ›´æ–°-æ‰¹é‡
```java
/**
 * æ›´æ–°-æ‰¹é‡
 * @param paramJsons
 */
public void updateBatch(JSONObject[] paramJsons) {
	String sql =
			"UPDATE table_example \n" +
			"SET nickname = :nickname \n" +
			"WHERE\n" +
			"	1 = 1 \n" +
			"	AND user_id > :user_id";
	int[] updateRowsNumbers = db.updateBatch(sql, paramJsons);
	Console.log(Arrays.toString(updateRowsNumbers));
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

## æŸ¥
### åˆ—è¡¨
```java
/**
 * åˆ—è¡¨
 * 
 * @param paramJson æŸ¥è¯¢å‚æ•°
 * @return åˆ—è¡¨æ•°æ®
 */
public List<JSONObject> list(JSONObject paramJson) {
	return db.query(tableName(), paramJson, DBSortEnum.é™åº);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

### SQLæŸ¥è¯¢
```java	
public void query(JSONObject paramJson) {
	// 1. æŸ¥è¯¢SQL
	String sqlGet = "SELECT * FROM table_example WHERE id = 1";
	String sqlList = "SELECT * FROM table_example";

	// 2. æŸ¥è¯¢
	JSONObject jsonObject = db.queryForJson(sqlGet, paramJson);
	UserDO userDO = db.queryForObject(sqlGet, paramJson, UserDO.class);
	List<JSONObject> jsonObjectList = db.queryForList(sqlList, paramJson);
	List<UserDO> userDOList = db.queryForList(sqlList, paramJson, UserDO.class);
}
```

æ›´å¤šæ–¹æ³•è¯·å‚é˜…APIæ–‡æ¡£...

### åˆ†é¡µ
**ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹åˆ†é¡µä¼˜åŒ–è§„çº¦ï¼š**

![åˆ†é¡µä¼˜åŒ–è§„çº¦](jdbc_files/åˆ†é¡µä¼˜åŒ–è§„çº¦.jpg)

`PageIPO`ç±»å°±æ˜¯ä¸€ä¸ªåˆ†é¡µå®ä½“ç±»ï¼ŒåŒ…å«`page`ï¼ˆå½“å‰é¡µï¼‰ã€`limit`ï¼ˆæ¯é¡µæ˜¾ç¤ºçš„æ¡æ•°ï¼‰ã€`conditions`ï¼ˆæŸ¥è¯¢æ¡ä»¶ï¼‰

#### æ¡ä»¶åˆ†é¡µ
```java
/**
 * åˆ†é¡µ
 * @param pageIPO
 * @return
 */
public PageVO pageWhere(PageIPO pageIPO) {
	String whereSql = "WHERE 1 = 1 AND user_id >= :user_id";
	return db.pageWhere(tableName(), whereSql, pageIPO);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

#### å¤æ‚åˆ†é¡µï¼Œä¼ å…¥SQLæŸ¥è¯¢è¯­å¥
```java
/**
 * åˆ†é¡µ
 *
 * @param pageIPO
 * @return
 */
public PageVO pageSql(PageIPO pageIPO) {
	// ç¤ºä¾‹sqlä¸ºsqlä¼˜åŒ–å‹åˆ†é¡µsqlï¼Œè§£å†³mysql limitåˆ†é¡µç¼ºé™·
	String querySql =
			"SELECT\n" +
			"	a.* \n" +
			"FROM\n" +
			"	table_example a,\n" +
			"	( SELECT id FROM table_example WHERE 1 > 5 LIMIT 0, 10 ) b \n" +
			"WHERE\n" +
			"	a.id = b.id";
	return db.pageSql(querySql, pageIPO);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

#### æ ¹æ®ç›¸åŒçš„åˆ—è¡¨æ¡ä»¶ï¼Œè·å¾—ä¸Šä¸€æ¡ä¸ä¸‹ä¸€æ¡æ•°æ®
ä½¿ç”¨åœºæ™¯ï¼šæŠ–éŸ³åˆ·è§†é¢‘ç­‰
```java
/**
 * åˆ†é¡µ-ä¸Šä¸€æ¡ä¸ä¸‹ä¸€æ¡æ•°æ®
 * 
 * @param pageIPO
 * @return
 */
public PageBeforeAndAfterVO pageBeforeAndAfter(PageIPO pageIPO) {
	String querySql = "";
	Long equalsId = 30L;
	return db.pageBeforeAndAfter(querySql, pageIPO, equalsId);
}

// ...æ›´å¤šé‡è½½æ–¹æ³•
```

[ğŸ‘‰æ‰©å±•é˜…è¯»-ä¸€æ¬¡SQLæŸ¥è¯¢ä¼˜åŒ–åŸç†åˆ†æï¼ˆ900W+æ•°æ®ï¼Œä»17såˆ°300msï¼‰](https://www.jianshu.com/p/0768ebc4e28d)