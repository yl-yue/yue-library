# åŠ¨æ€æ•°æ®æº
## ä½¿ç”¨åœºæ™¯
- å¤šæ•°æ®æºé…ç½®
- åŠ¨æ€æ•°æ®æºåˆ‡æ¢
- å¤šç§Ÿæˆ·

## å®ç°æ–¹æ¡ˆ
1. å¼•å…¥[dynamic-datasource-spring-boot-starter](https://github.com/baomidou/dynamic-datasource-spring-boot-starter)ã€‚
<a href="http://mvnrepository.com/artifact/com.baomidou/dynamic-datasource-spring-boot-starter" target="_blank">
<img src="https://img.shields.io/maven-central/v/com.baomidou/dynamic-datasource-spring-boot-starter.svg" ></a>

```xml
<dependency>
  <groupId>com.baomidou</groupId>
  <artifactId>dynamic-datasource-spring-boot-starter</artifactId>
  <version>${version}</version>
</dependency>
```
2. é…ç½®æ•°æ®æºã€‚

```yaml
spring:
  datasource:
    dynamic:
      primary: master #è®¾ç½®é»˜è®¤çš„æ•°æ®æºæˆ–è€…æ•°æ®æºç»„,é»˜è®¤å€¼å³ä¸ºmaster
      strict: false #è®¾ç½®ä¸¥æ ¼æ¨¡å¼,é»˜è®¤falseä¸å¯åŠ¨. å¯åŠ¨ååœ¨æœªåŒ¹é…åˆ°æŒ‡å®šæ•°æ®æºæ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸,ä¸å¯åŠ¨åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®æº.
      datasource:
        master:
          url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver # 3.2.0å¼€å§‹æ”¯æŒSPIå¯çœç•¥æ­¤é…ç½®
        slave_1:
          url: jdbc:mysql://xx.xx.xx.xx:3307/dynamic
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver
        slave_2:
          url: ENC(xxxxx) # å†…ç½®åŠ å¯†,ä½¿ç”¨è¯·æŸ¥çœ‹è¯¦ç»†æ–‡æ¡£
          username: ENC(xxxxx)
          password: ENC(xxxxx)
          driver-class-name: com.mysql.jdbc.Driver
          schema: db/schema.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–è¡¨ç»“æ„
          data: db/data.sql # é…ç½®åˆ™ç”Ÿæ•ˆ,è‡ªåŠ¨åˆå§‹åŒ–æ•°æ®
          continue-on-error: true # é»˜è®¤true,åˆå§‹åŒ–å¤±è´¥æ˜¯å¦ç»§ç»­
          separator: ";" # sqlé»˜è®¤åˆ†å·åˆ†éš”ç¬¦
          
       #......çœç•¥
       #ä»¥ä¸Šä¼šé…ç½®ä¸€ä¸ªé»˜è®¤åº“masterï¼Œä¸€ä¸ªç»„slaveä¸‹æœ‰ä¸¤ä¸ªå­åº“slave_1,slave_2
```

```yaml
# å¤šä¸»å¤šä»                      çº¯ç²¹å¤šåº“ï¼ˆè®°å¾—è®¾ç½®primaryï¼‰                   æ··åˆé…ç½®
spring:                               spring:                               spring:
  datasource:                           datasource:                           datasource:
    dynamic:                              dynamic:                              dynamic:
      datasource:                           datasource:                           datasource:
        master_1:                             mysql:                                master:
        master_2:                             oracle:                               slave_1:
        slave_1:                              sqlserver:                            slave_2:
        slave_2:                              postgresql:                           oracle_1:
        slave_3:                              h2:                                   oracle_2:
```

3. ä½¿ç”¨  **@DS**  åˆ‡æ¢æ•°æ®æºã€‚

**@DS** å¯ä»¥æ³¨è§£åœ¨æ–¹æ³•ä¸Šæˆ–ç±»ä¸Šï¼Œ**åŒæ—¶å­˜åœ¨å°±è¿‘åŸåˆ™ æ–¹æ³•ä¸Šæ³¨è§£ ä¼˜å…ˆäº ç±»ä¸Šæ³¨è§£**ã€‚

|     æ³¨è§£      |                   ç»“æœ                   |
| :-----------: | :--------------------------------------: |
|    æ²¡æœ‰@DS    |                é»˜è®¤æ•°æ®æº                |
| @DS("dsName") | dsNameå¯ä»¥ä¸ºç»„åä¹Ÿå¯ä»¥ä¸ºå…·ä½“æŸä¸ªåº“çš„åç§° |

```java
@Service
@DS("slave")
public class UserServiceImpl implements UserService {

  @Autowired
  private JdbcTemplate jdbcTemplate;

  public List selectAll() {
    return  jdbcTemplate.queryForList("select * from user");
  }
  
  @Override
  @DS("slave_1")
  public List selectByCondition() {
    return  jdbcTemplate.queryForList("select * from user where age >10");
  }
}
```

[ğŸ‘‰ç‚¹å‡»æŸ¥çœ‹æ›´å¤šæ–‡æ¡£ä»‹ç»](https://dynamic-datasource.com/)

## é›†æˆDruid
### åŸºç¡€ä»‹ç»
- Druid Github <https://github.com/alibaba/druid>
- Druid æ–‡æ¡£ <https://github.com/alibaba/druid/wiki>

[dynamic-datasource-spring-boot-starter](https://github.com/baomidou/dynamic-datasource-spring-boot-starter)ç»„ä»¶èƒ½```ç®€å•é«˜æ•ˆ``` :cherry_blossom:å®Œæˆå¯¹Druidçš„é›†æˆå¹¶å®Œæˆå…¶å‚æ•°çš„å¤šå…ƒåŒ–é…ç½®ã€‚

::: tip æç¤º
1.å„ä¸ªåº“å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ•°æ®åº“è¿æ¥æ± ï¼Œå¦‚  **masterä½¿ç”¨Druidç›‘æ§ï¼Œä»åº“ä½¿ç”¨HikariCP**ã€‚

2.å¦‚æœé¡¹ç›®åŒæ—¶å­˜åœ¨Druidå’ŒHikariCPå¹¶ä¸”æœªé…ç½®è¿æ¥æ± typeç±»å‹ï¼Œé»˜è®¤ **Druidä¼˜å…ˆäºHikariCP** ã€‚
:::

### å¦‚ä½•é›†æˆ
1. é¡¹ç›®å¼•å…¥ `druid-spring-boot-starter` ä¾èµ–ã€‚
<a href="http://mvnrepository.com/artifact/com.alibaba/druid" target="_blank">
<img src="https://img.shields.io/maven-central/v/com.alibaba/druid.svg" ></a>

```xml
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid-spring-boot-starter</artifactId>
    <version>${version}</version>
</dependency>
```

2. æ’é™¤åŸç”ŸDruidçš„å¿«é€Ÿé…ç½®ç±»ã€‚:sweat_drops:

```java
@SpringBootApplication(exclude = DruidDataSourceAutoConfigure.class)
public class Application {

  public static void main(String[] args) {
    SpringApplication.run(Application.class, args);
  }
}
```

3. æŸäº›springBootçš„ç‰ˆæœ¬ä¸Šé¢å¯èƒ½æ— æ³•æ’é™¤å¯ç”¨ä»¥ä¸‹æ–¹å¼æ’é™¤ã€‚

```yaml
spring:
  autoconfigure:
    exclude: com.alibaba.druid.spring.boot.autoconfigure.DruidDataSourceAutoConfigure
```

### å‚æ•°é…ç½®
1. :heart: å¦‚æœå‚æ•°éƒ½æœªé…ç½®ï¼Œåˆ™ä¿æŒåŸç»„ä»¶é»˜è®¤å€¼ã€‚
2. :yellow_heart: å¦‚æœé…ç½®äº†å…¨å±€å‚æ•°ï¼Œåˆ™æ¯ä¸€ä¸ªæ•°æ®æºéƒ½ä¼šç»§æ‰¿å¯¹åº”å‚æ•°ã€‚ 
3. :blue_heart: æ¯ä¸€ä¸ªæ•°æ®æºå¯ä»¥å•ç‹¬è®¾ç½®å‚æ•°è¦†ç›–å…¨å±€å‚æ•°ã€‚

```yaml
spring:
  datasource:
    druid:
      stat-view-servlet:
        enabled: true
        loginUsername: admin
        loginPassword: 123456
    dynamic:
      druid: #ä»¥ä¸‹æ˜¯æ”¯æŒçš„å…¨å±€é»˜è®¤å€¼
        initial-size:
        max-active:
        min-idle:
        max-wait:
        time-between-eviction-runs-millis:
        time-between-log-stats-millis:
        stat-sqlmax-size:
        min-evictable-idle-time-millis:
        max-evictable-idle-time-millis:
        test-while-idle:
        test-on-borrow:
        test-on-return:
        validation-query:
        validation-query-timeout:
        use-global-datasource-stat:
        async-init:
        clear-filters-enable:
        reset-stat-enable:
        not-full-timeout-retry-count:
        max-wait-thread-count:
        fail-fast:
        phyTimeout-millis:
        keep-alive:
        pool-prepared-statements:
        init-variants:
        init-global-variants:
        use-unfair-lock:
        kill-when-socket-read-timeout:
        connection-properties:
        max-pool-prepared-statement-per-connection-size:
        init-connection-sqls:
        share-prepared-statements:
        connection-errorretry-attempts:
        break-after-acquire-failure:
        filters: stat,wall # æ³¨æ„è¿™ä¸ªå€¼å’ŒdruidåŸç”Ÿä¸ä¸€è‡´ï¼Œé»˜è®¤å¯åŠ¨äº†stat,wall
        wall:
            noneBaseStatementAllow:
            callAllow:
            selectAllow:
            selectIntoAllow:
            selectIntoOutfileAllow:
            selectWhereAlwayTrueCheck:
            selectHavingAlwayTrueCheck:
            selectUnionCheck:
            selectMinusCheck:
            selectExceptCheck:
            selectIntersectCheck:
            createTableAllow:
            dropTableAllow:
            alterTableAllow:
            renameTableAllow:
            hintAllow:
            lockTableAllow:
            startTransactionAllow:
            blockAllow:
            conditionAndAlwayTrueAllow:
            conditionAndAlwayFalseAllow:
            conditionDoubleConstAllow:
            conditionLikeTrueAllow:
            selectAllColumnAllow:
            deleteAllow:
            deleteWhereAlwayTrueCheck:
            deleteWhereNoneCheck:
            updateAllow:
            updateWhereAlayTrueCheck:
            updateWhereNoneCheck:
            insertAllow:
            mergeAllow:
            minusAllow:
            intersectAllow:
            replaceAllow:
            setAllow:
            commitAllow:
            rollbackAllow:
            useAllow:
            multiStatementAllow:
            truncateAllow:
            commentAllow:
            strictSyntaxCheck:
            constArithmeticAllow:
            limitZeroAllow:
            describeAllow:
            showAllow:
            schemaCheck:
            tableCheck:
            functionCheck:
            objectCheck:
            variantCheck:
            mustParameterized:
            doPrivilegedAllow:
            dir:
            tenantTablePattern:
            tenantColumn:
            wrapAllow:
            metadataAllow:
            conditionOpXorAllow:
            conditionOpBitwseAllow:
            caseConditionConstAllow:
            completeInsertValuesCheck:
            insertValuesCheckSize:
            selectLimit:
        stat:
          merge-sql:
          log-slow-sql:
          slow-sql-millis: 
      datasource:
        master:
          username: root
          password: 123456
          driver-class-name: com.mysql.jdbc.Driver
          url: jdbc:mysql://xx.xx.xx.xx:3306/dynamic?characterEncoding=utf8&useSSL=false
          druid: # ä»¥ä¸‹æ˜¯ç‹¬ç«‹å‚æ•°ï¼Œæ¯ä¸ªåº“å¯ä»¥é‡æ–°è®¾ç½®
            initial-size:
            validation-query: select 1 FROM DUAL #æ¯”å¦‚oracleå°±éœ€è¦é‡æ–°è®¾ç½®è¿™ä¸ª
            public-key: #ï¼ˆéå…¨å±€å‚æ•°ï¼‰è®¾ç½®å³è¡¨ç¤ºå¯ç”¨åŠ å¯†,åº•å±‚ä¼šè‡ªåŠ¨å¸®ä½ é…ç½®ç›¸å…³çš„è¿æ¥å‚æ•°å’Œfilterï¼Œæ¨èä½¿ç”¨æœ¬é¡¹ç›®è‡ªå¸¦çš„åŠ å¯†æ–¹æ³•ã€‚
#           ......

# ç”Ÿæˆ publickey å’Œå¯†ç ï¼Œæ¨èä½¿ç”¨æœ¬é¡¹ç›®è‡ªå¸¦çš„åŠ å¯†æ–¹æ³•ã€‚
# java -cp druid-1.1.10.jar com.alibaba.druid.filter.config.ConfigTools youpassword
```

å¦‚ä¸Šå³å¯é…ç½®è®¿é—®ç”¨æˆ·å’Œå¯†ç ï¼Œè®¿é—® <http://localhost:8080/druid/index.html> æŸ¥çœ‹druidç›‘æ§ã€‚