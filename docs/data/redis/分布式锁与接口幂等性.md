# 分布式锁与接口幂等性
## 分布式锁
> [👉漫画：什么是分布式锁？](https://mp.weixin.qq.com/s/8fdBKAyHZrfHmSajXT_dnA)

锁有公平锁、阻塞锁、可重入锁等概念，适用于不同业务场景：
- 具有公平特性的锁：支持阻塞，不支持争抢，按请求先后顺序排队
- 具有可阻塞特性的锁：支持选择性阻塞等待，直到获取锁
- 具有可重入特性的锁：支持同一线程在递归或循环中重复持有同一把锁，在递归或循环结束时释放锁

### 使用示例
- 对单个用户的访问进行加锁，可实现接口幂等性等场景

```java
// 准备参数
String lockKey = Redis.redisKey("userId", userId);
int lockTimeout = 3600;

// 加锁
LockInfo lock = redis.lock(lockKey, lockTimeout);
if (lock.isLock() == false) {
	return R.errorPrompt(StrUtil.format("用户{}未拿到锁", userId));
}

// 业务逻辑 ...

// 解锁
redis.unlock(lock);
}
```

### 相关知识
> - [使用分布式锁时考虑哪些问题](https://www.cnblogs.com/geyifan/p/6506168.html)
> - [注解方式优雅的实现 Redisson 分布式锁](https://mp.weixin.qq.com/s/x8w3MukIUG7Lpv1VNCUV6Q)
> - [SpringBoot-Starter 造轮子之自动锁组件](https://mp.weixin.qq.com/s/noThlOtWQcvvYeviExrfnQ)
> - [SpEL表达式](https://www.jianshu.com/p/a8b2d5886129)
> - [SpEL表达式详解](https://blog.csdn.net/weixin_43888891/article/details/127520555)

## 接口幂等性
- 即接口防抖、防重复提交、防事务攻击，杜绝无意或恶意破坏
  - 如：用户在APP上连续点击了多次提交订单，后台应该只产生一个订单（后台应该时刻保持不信任前端的态度）
- 即你的所有POST提交、PUT更新接口，都应该实现接口幂等（如：交易订单、充值抽奖、用户新增等）

### 开始使用
1. 在接口加上`@ApiIdempotent`注解
```java
@ApiIdempotent
@PostMapping("/test")
public Result<?> test(JSONObject paramJson) {
	return R.success(paramJson);
}
```

2. 正确调用响应（未重复提交）
```json
{
    "code": 200,
    "msg": "成功",
    "flag": true,
    "traceId": "",
    "data": {
        "role": "admin",
        "userStatus": "normal",
        "cellphone": "18523246334"
    }
}
```

3. 错误请求时的响应示例（重复提交）
```json
{
    "code": 436,
    "msg": "请勿重复操作",
    "flag": false,
    "traceId": "",
    "data": "【幂等性】幂等校验失败，请求校验参数 key: all，请求校验参数 value: all"
}
```

### `@ApiIdempotent`（接口幂等性注解）
`paramKeys`：唯一索引条件key（加锁、幂等条件）
- 如：**userId**、**token**等 -- 基于用户进行加锁，同一用户对同一接口的请求，必须执行完毕后才能发起新的请求，否则视为重复请求（无效请求）
- `key`的`value`会依次从**Header**、**Query**、**Body**中获取
- 支持联合唯一约束，即多个参数作为条件
- 此参数如果为空，即全局加锁，同一时间只全局处理一个请求，其他请求将返回重复请求提示

`expire`：幂等锁过期时间（单位：毫秒）

```java
@ApiIdempotent(paramKeys = "cellphone")
@PostMapping("/test")
public Result<?> test(JSONObject paramJson) {
	return R.success(paramJson);
}
```

### 相关知识
> - [👉Spring Boot 实现接口幂等性的 4 种方案](https://mp.weixin.qq.com/s/HmKCBqYW7JfWUSyjv8J8Ww)
> - [👉SpringBoot接口防抖(防重复提交)的一些实现方案](https://mp.weixin.qq.com/s/ZKaRoD6mQcvQRxYWAQQCWA)
