# åˆ†å¸ƒå¼ç¼“å­˜
ä»€ä¹ˆæ˜¯åˆ†å¸ƒå¼ç¼“å­˜ï¼Ÿåœ¨å®é™…å¼€å‘åœºæ™¯ä¸­ï¼Œå¾€å¾€å•æœºåº”ç”¨æ— æ³•æ»¡è¶³å½“å‰çš„éœ€æ±‚ï¼Œéœ€è¦å¯¹é¡¹ç›®è¿›è¡Œåˆ†å¸ƒå¼éƒ¨ç½²ï¼Œç”±æ­¤æ¯ä¸ªé¡¹ç›®ä¸­çš„ç¼“å­˜éƒ½æ˜¯å±äºè‡ªå·±ç‹¬ç«‹æœåŠ¡çš„ï¼Œå¹¶ä¸èƒ½å…±äº«ï¼Œå…¶æ¬¡å½“æŸä¸ªæœåŠ¡æ›´æ–°äº†ç¼“å­˜ï¼Œå…¶ä»–æœåŠ¡å¹¶ä¸çŸ¥é“ï¼Œå½“ç”¨æˆ·è¯·æ±‚åˆ°å…¶ä»–æœåŠ¡æ—¶ï¼Œè·å–åˆ°çš„å¾€å¾€è¿˜æ˜¯æ—§çš„æ•°æ®ã€‚
è¿™æ—¶å°±éœ€è¦å°†ç¼“å­˜çš„æ•°æ®æ”¾åœ¨ä¸€ä¸ªç»Ÿä¸€çš„åœ°æ–¹è¿›è¡Œç®¡ç†ï¼Œå¦‚ï¼šredis

## æ³¨è§£ä»‹ç»
Springä¸ºæˆ‘ä»¬æä¾›äº†ä¸‰å¤§æ³¨è§£`@Cacheable`ã€`@CachePut`ã€`@CacheEvict`å¯åœ¨ç»å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ä¼˜é›…å®ç°åˆ†å¸ƒå¼ç¼“å­˜ã€‚

### @EnableCachingï¼ˆå¯ç”¨ç¼“å­˜ï¼‰
ä¸€èˆ¬æ³¨è§£åœ¨å¯åŠ¨ç±»æˆ–é…ç½®ç±»ä¸Šï¼Œè¡¨ç¤ºå¯ç”¨ç¼“å­˜ï¼Œä½¿`@Cacheable`ã€`@CachePut`ã€`@CacheEvict`ç­‰æ³¨è§£ç”Ÿæ•ˆã€‚

### @Cacheableï¼ˆæ·»åŠ /è·å–ç¼“å­˜ï¼‰
|å±æ€§å				|ä½œç”¨																																													|
|--					|--																																														|
|cacheNames/value	|ç¼“å­˜åï¼ˆå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªå€¼ï¼‰ï¼Œå³ç¼“å­˜å‘½åç©ºé—´åç§°ï¼Œç”¨äºç¡®å®šç¼“å­˜ç›®æ ‡ã€‚																													|
|key				|ç¼“å­˜keyï¼Œç¼ºçœä¸ºæŒ‰ç…§æ–¹æ³•çš„æ‰€æœ‰å…¥å‚è¿›è¡Œç»„åˆï¼Œå¯ä»¥ä½¿ç”¨SpELè¡¨è¾¾å¼ï¼Œå®é™…å­˜å‚¨keyæ—¶é»˜è®¤ä»¥`cacheNames/value`ä½œä¸ºå‰ç¼€ã€‚																			|
|keyGenerator		|æŒ‡å®škeyçš„ç”Ÿæˆå™¨ç”Ÿæˆé”®å€¼keyï¼ˆä¸`key`äºŒé€‰ä¸€ï¼‰ï¼Œéå¿…éœ€ã€‚																																	|
|cacheManager		|æŒ‡å®šç¼“å­˜ç®¡ç†å™¨(ä¾‹å¦‚ConcurrentHashMapã€Redisç­‰)ï¼Œéå¿…éœ€ã€‚																																|
|cacheResolver		|å’ŒcacheManagerä½œç”¨ä¸€æ ·ï¼Œä½¿ç”¨æ—¶äºŒé€‰ä¸€ï¼Œéå¿…éœ€ã€‚																																			|
|condition			|æŒ‡å®šç¼“å­˜çš„æ¡ä»¶ï¼ˆå¯¹å‚æ•°åˆ¤æ–­ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ—¶æ‰ç¼“å­˜ï¼‰ï¼Œå¯ç”¨SpELè¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼šæ–¹æ³•å…¥å‚ä¸ºå¯¹è±¡useråˆ™è¡¨è¾¾å¼å¯ä»¥å†™ä¸º`condition = "#user.age>18"`ï¼Œè¡¨ç¤ºå½“å…¥å‚å¯¹è±¡userçš„å±æ€§ageå¤§äº18æ‰è¿›è¡Œç¼“å­˜ã€‚|
|unless				|å¦å®šç¼“å­˜çš„æ¡ä»¶ï¼ˆå¯¹ç»“æœåˆ¤æ–­ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ—¶ä¸ç¼“å­˜ï¼‰ï¼Œå³æ»¡è¶³unlessæŒ‡å®šçš„æ¡ä»¶æ—¶ï¼Œå¯¹è°ƒç”¨æ–¹æ³•è·å–çš„ç»“æœä¸è¿›è¡Œç¼“å­˜ï¼Œä¾‹å¦‚ï¼š`unless = "result==null"`ï¼Œè¡¨ç¤ºå¦‚æœç»“æœä¸ºnullæ—¶ä¸ç¼“å­˜ã€‚			|
|sync				|æ˜¯å¦ä½¿ç”¨å¼‚æ­¥æ¨¡å¼è¿›è¡Œç¼“å­˜ï¼Œé»˜è®¤falseã€‚																																					|

ä»¥`cache_test`ä½œä¸ºç¼“å­˜åï¼Œå‚æ•°`id`ä½œä¸ºç¼“å­˜keyï¼Œå¦‚æœå‘½ä¸­ç¼“å­˜ï¼Œç›´æ¥è¿”å›ç»“æœã€‚å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œå°±æ‰§è¡Œæ–¹æ³•é€»è¾‘ï¼Œå¹¶å°†æ–¹æ³•çš„è¿”å›ç»“æœç¼“å­˜ã€‚
```java
@Cacheable(value = "cache_test", key = "#id")
@GetMapping("/get")
public Result<?> get(Long id) {
	return R.success(jdbcDAO.get(id));
}
```

### @CachePutï¼ˆæ›´æ–°ç¼“å­˜ï¼‰
|å±æ€§å				|ä½œç”¨ä¸æè¿°																																												|
|--					|--																																														|
|cacheNames/value	|ç¼“å­˜åï¼ˆå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªå€¼ï¼‰ï¼Œå³ç¼“å­˜å‘½åç©ºé—´åç§°ï¼Œç”¨äºç¡®å®šç¼“å­˜ç›®æ ‡ã€‚																													|
|key				|ç¼“å­˜keyï¼Œç¼ºçœä¸ºæŒ‰ç…§æ–¹æ³•çš„æ‰€æœ‰å…¥å‚è¿›è¡Œç»„åˆï¼Œå¯ä»¥ä½¿ç”¨SpELè¡¨è¾¾å¼ï¼Œå®é™…å­˜å‚¨keyæ—¶é»˜è®¤ä»¥`cacheNames/value`ä½œä¸ºå‰ç¼€ã€‚																			|
|keyGenerator		|æŒ‡å®škeyçš„ç”Ÿæˆå™¨ç”Ÿæˆé”®å€¼keyï¼ˆä¸`key`äºŒé€‰ä¸€ï¼‰ï¼Œéå¿…éœ€ã€‚																																	|
|cacheManager		|æŒ‡å®šç¼“å­˜ç®¡ç†å™¨(ä¾‹å¦‚ConcurrentHashMapã€Redisç­‰)ï¼Œéå¿…éœ€ã€‚																																|
|cacheResolver		|å’ŒcacheManagerä½œç”¨ä¸€æ ·ï¼Œä½¿ç”¨æ—¶äºŒé€‰ä¸€ï¼Œéå¿…éœ€ã€‚																																			|
|condition			|æŒ‡å®šç¼“å­˜çš„æ¡ä»¶ï¼ˆå¯¹å‚æ•°åˆ¤æ–­ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ—¶æ‰ç¼“å­˜ï¼‰ï¼Œå¯ç”¨SpELè¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼šæ–¹æ³•å…¥å‚ä¸ºå¯¹è±¡useråˆ™è¡¨è¾¾å¼å¯ä»¥å†™ä¸º`condition = "#user.age>18"`ï¼Œè¡¨ç¤ºå½“å…¥å‚å¯¹è±¡userçš„å±æ€§ageå¤§äº18æ‰è¿›è¡Œç¼“å­˜ã€‚|
|unless				|å¦å®šç¼“å­˜çš„æ¡ä»¶ï¼ˆå¯¹ç»“æœåˆ¤æ–­ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ—¶ä¸ç¼“å­˜ï¼‰ï¼Œå³æ»¡è¶³unlessæŒ‡å®šçš„æ¡ä»¶æ—¶ï¼Œå¯¹è°ƒç”¨æ–¹æ³•è·å–çš„ç»“æœä¸è¿›è¡Œç¼“å­˜ï¼Œä¾‹å¦‚ï¼š`unless = "result==null"`ï¼Œè¡¨ç¤ºå¦‚æœç»“æœä¸ºnullæ—¶ä¸ç¼“å­˜ã€‚			|

ä»¥`cache_test`ä½œä¸ºç¼“å­˜åï¼Œå‚æ•°`id`ä½œä¸ºç¼“å­˜keyï¼Œå½“æ–¹æ³•é€»è¾‘æ‰§è¡Œå®Œä¹‹åï¼Œå°†è¿”å›ç»“æœè¿›è¡Œè¦†ç›–ç¼“å­˜ã€‚
```java
@CachePut(value = "cache_test", key = "#userGroupIPO.id")
@PutMapping("/put")
public Result<?> put(@Validated UserGroupIPO userGroupIPO) {
	jdbcDAO.updateById(Convert.toJSONObject(userGroupIPO));
	return R.success(jdbcDAO.get(userGroupIPO.getId()));
}
```

### @CacheEvictï¼ˆåˆ é™¤ç¼“å­˜ï¼‰
|å±æ€§å				|ä½œç”¨ä¸æè¿°																																																													|
|--					|--																																																															|
|cacheNames/value	|ç¼“å­˜åï¼ˆå¿…é¡»æŒ‡å®šè‡³å°‘ä¸€ä¸ªå€¼ï¼‰ï¼Œå³ç¼“å­˜å‘½åç©ºé—´åç§°ï¼Œç”¨äºç¡®å®šç¼“å­˜ç›®æ ‡ã€‚																																														|
|key				|ç¼“å­˜keyï¼Œç¼ºçœä¸ºæŒ‰ç…§æ–¹æ³•çš„æ‰€æœ‰å…¥å‚è¿›è¡Œç»„åˆï¼Œå¯ä»¥ä½¿ç”¨SpELè¡¨è¾¾å¼ï¼Œå®é™…å­˜å‚¨keyæ—¶é»˜è®¤ä»¥`cacheNames/value`ä½œä¸ºå‰ç¼€ã€‚																																				|
|keyGenerator		|æŒ‡å®škeyçš„ç”Ÿæˆå™¨ç”Ÿæˆé”®å€¼keyï¼ˆä¸`key`äºŒé€‰ä¸€ï¼‰ï¼Œéå¿…éœ€ã€‚																																																		|
|cacheManager		|æŒ‡å®šç¼“å­˜ç®¡ç†å™¨(ä¾‹å¦‚ConcurrentHashMapã€Redisç­‰)ï¼Œéå¿…éœ€ã€‚																																																	|
|cacheResolver		|å’ŒcacheManagerä½œç”¨ä¸€æ ·ï¼Œä½¿ç”¨æ—¶äºŒé€‰ä¸€ï¼Œéå¿…éœ€ã€‚																																																				|
|condition			|æŒ‡å®šåˆ é™¤ç¼“å­˜çš„æ¡ä»¶ï¼ˆå¯¹å‚æ•°åˆ¤æ–­ï¼Œæ»¡è¶³ä»€ä¹ˆæ¡ä»¶æ—¶æ‰åˆ é™¤ç¼“å­˜ï¼‰ï¼Œå¯ç”¨SpELè¡¨è¾¾å¼ï¼Œä¾‹å¦‚ï¼šå…¥å‚ä¸ºå­—ç¬¦userIdçš„æ–¹æ³•åˆ é™¤ç¼“å­˜æ¡ä»¶è®¾å®šä¸ºå½“å…¥å‚ä¸æ˜¯user001å°±åˆ é™¤ç¼“å­˜ï¼Œåˆ™è¡¨è¾¾å¼å¯ä»¥å†™ä¸º`condition = "!('user001').equals(#userId)"`ã€‚										|
|allEntries			|allEntriesæ˜¯å¸ƒå°”ç±»å‹çš„ï¼Œç”¨æ¥è¡¨ç¤ºæ˜¯å¦éœ€è¦æ¸…é™¤ç¼“å­˜ä¸­çš„æ‰€æœ‰å…ƒç´ ã€‚é»˜è®¤å€¼ä¸ºfalse,è¡¨ç¤ºä¸éœ€è¦ã€‚å½“æŒ‡å®šallEntriesä¸ºtrueæ—¶ï¼ŒSpring Cacheå°†å¿½ç•¥æŒ‡å®šçš„key,æ¸…é™¤ç¼“å­˜ä¸­çš„æ‰€æœ‰å†…å®¹ã€‚																						|
|beforeInvocation	|æ¸…é™¤æ“ä½œé»˜è®¤æ˜¯åœ¨å¯¹åº”æ–¹æ³•æ‰§è¡ŒæˆåŠŸåè§¦å‘çš„ï¼ˆbeforeInvocation = falseï¼‰ï¼Œå³æ–¹æ³•å¦‚æœå› ä¸ºæŠ›å‡ºå¼‚å¸¸è€Œæœªèƒ½æˆåŠŸè¿”å›æ—¶åˆ™ä¸ä¼šè§¦å‘æ¸…é™¤æ“ä½œã€‚ä½¿ç”¨beforeInvocationå±æ€§å¯ä»¥æ”¹å˜è§¦å‘æ¸…é™¤æ“ä½œçš„æ—¶é—´ã€‚å½“æŒ‡å®šè¯¥å±æ€§å€¼ä¸ºtrueæ—¶ï¼ŒSpringä¼šåœ¨è°ƒç”¨è¯¥æ–¹æ³•ä¹‹å‰æ¸…é™¤ç¼“å­˜ä¸­çš„æŒ‡å®šå…ƒç´ ã€‚	|

ä»¥`cache_test`ä½œä¸ºç¼“å­˜åï¼Œå‚æ•°`id`ä½œä¸ºç¼“å­˜keyï¼Œå½“æ–¹æ³•é€»è¾‘æ‰§è¡Œå®Œä¹‹åï¼Œåˆ é™¤ç¼“å­˜ã€‚
```java
@CacheEvict(value = "cache_test", key = "#id")
@DeleteMapping("/delete")
public Result<?> delete(@RequestParam("id") Long id) {
	jdbcDAO.deleteLogic(id);
	return R.success();
}
```

### @CacheConfig
æ³¨è§£åœ¨ç±»ä¸Šé¢ï¼Œå¯ä½¿`@Cacheable`ã€`@CachePut`ã€`@CacheEvict`æ³¨è§£æ— éœ€å®šä¹‰é‡å¤çš„ï¼š`cacheNames/valueã€keyGeneratorã€cacheManagerã€cacheResolver`å±æ€§å€¼
```java
@CacheConfig(cacheNames = "cache_test")
@RestController
@RequestMapping("/cache")
public class CacheController {

    @Autowired
    JdbcDAO jdbcDAO;

    @Cacheable(key = "#id") // æ— éœ€é‡å¤æŒ‡å®š cacheNames/value å±æ€§
    @GetMapping("/get")
    public Result<?> get(Long id) {
        return R.success(jdbcDAO.get(id));
    }

}
```

### @Caching
ç”¨äºå°†`@Cacheableã€@CachePutã€@CacheEvict`è¿™ä¸‰ä¸ªæ³¨è§£æ‰€æä¾›çš„èƒ½åŠ›è‡ªç”±ç»„åˆï¼Œå¦‚æŸ¥è¯¢ç”¨æˆ·æ—¶ç¼“å­˜ä¸åº”è¯¥åªæ”¾id â†’ userï¼Œåº”è¯¥è¿åŒ cellphone â†’ userã€email â†’ userä¸€èµ·æ”¾å…¥ï¼Œè¿™æ ·ä¸‹æ¬¡å¦‚æœæŒ‰ç…§cellphoneæˆ–emailæ¥æŸ¥è¯¢æ—¶ï¼Œä¹Ÿå¯ä»ç¼“å­˜ä¸­å‘½ä¸­äº†ã€‚
```java
@Caching(
	cacheable = {
		@Cacheable(value = "cache_test", key = "#id")
	},
	put = {
		@CachePut(value = "cache_test", key = "#result.cellphone", condition = "#result != null"),
		@CachePut(value = "cache_test", key = "#result.email", condition = "#result != null")
	}
)
public UserDO getUserDO(Long id) {
	return jdbcDAO.get(id);
}
```

## å¼€å§‹ä½¿ç”¨
### å¯ç”¨ç¼“å­˜
åœ¨å¯åŠ¨ç±»ä¸­åŠ ä¸Š`@EnableCaching`æ³¨è§£å¼€å¯ç¼“å­˜
```java
@EnableCaching
@SpringBootApplication
public class TestApplication {

    public static void main(String[] args) throws Exception {
        SpringApplication.run(TestApplication.class, args);
    }

}
```

### ä½¿ç”¨ç¼“å­˜
```java
@Cacheable(value = "cache_test", key = "#id")
@GetMapping("/get")
public Result<?> get(Long id) {
	System.out.println("æœªå‘½ä¸­Redisç¼“å­˜ï¼Œä½¿ç”¨JDBCå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ã€‚");
	return R.success(jdbcDAO.get(id));
}
```

### æµ‹è¯•
http://localhost:8080/cache/get?id=18

**ç¬¬ä¸€æ¬¡è®¿é—®-æ§åˆ¶å°æ‰“å°ç»“æœï¼š**
```log
2021-06-05 19:15:34.041  INFO 44320 --- [nio-8080-exec-1] ai.yue.library.test.aspect.HttpAspect    : requestIp=0:0:0:0:0:0:0:1
2021-06-05 19:15:34.041  INFO 44320 --- [nio-8080-exec-1] ai.yue.library.test.aspect.HttpAspect    : requestUri=/cache/get
2021-06-05 19:15:34.041  INFO 44320 --- [nio-8080-exec-1] ai.yue.library.test.aspect.HttpAspect    : requestMethod=GET
2021-06-05 19:15:34.041  INFO 44320 --- [nio-8080-exec-1] ai.yue.library.test.aspect.HttpAspect    : requestHandlerMethod=ai.yue.library.test.controller.data.redis.CacheController.get()
æœªå‘½ä¸­Redisç¼“å­˜ï¼Œä½¿ç”¨JDBCå»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ã€‚
2021-06-05 19:54:11.332 DEBUG 44320 --- [nio-8080-exec-4] druid.sql.Statement                      : {conn-310002, pstmt-320001} executed.
select * from `user` where 1 = 1 and `id` = 18
```

**ç¬¬ä¸€æ¬¡è®¿é—®-å“åº”æ•°æ®ï¼š**
```json
{
    "code": 200,
    "msg": "æˆåŠŸ",
    "flag": true,
    "count": null,
    "data": {
        "id": 18,
        "sortIdx": null,
        "deleteTime": 0,
        "createTime": "2018-07-18 09:10:46",
        "updateTime": "2021-06-03 14:29:41",
        "cellphone": "185****6311",
        "email": null,
        "password": "***********************************************",
        "nickname": "å¼ ä¸‰ä¸°3",
        "sex": "ç”·"
    }
}
```

**ç¬¬äºŒæ¬¡è®¿é—®ï¼šç»“æœä¸ç¬¬ä¸€æ¬¡ç›¸åŒï¼Œä½†æœªæ‰“å°å‡ºæŸ¥è¯¢æ—¥å¿—ï¼Œå› æ­¤è¯æ˜å“åº”çš„ç»“æœæ˜¯å–çš„Redisç¼“å­˜æ•°æ®ï¼Œè€Œä¸æ˜¯æ‰§è¡Œçš„JDBCæŸ¥è¯¢ã€‚åŒæ—¶æˆ‘ä»¬ä¹Ÿç¡®è®¤ä¸‹Redisä¸­æ˜¯å¦æœ‰ç¼“å­˜æ•°æ®ï¼š**

![ç¡®è®¤Redisç¼“å­˜](redis_files/1.jpg)

### ç»´æŠ¤ç¼“å­˜
ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†å¦‚ä½•ä½¿ç”¨`@Cacheable`æ³¨è§£æ·»åŠ ä¸è·å–ç¼“å­˜ï¼Œå®é™…åœºæ™¯ä¸­æˆ‘ä»¬è¿˜éœ€è¦æ›´æ–°ç¼“å­˜`@CachePut`ä¸åˆ é™¤ç¼“å­˜`@CacheEvict`ã€‚
å¼€å‘è€…éœ€è¦ç»“åˆä¸šåŠ¡æƒ…å†µï¼Œåœ¨éœ€è¦æ“ä½œåˆ°ç¼“å­˜ç›¸å…³æ•°æ®æ—¶ï¼Œè¿›è¡Œç¼“å­˜æ•°æ®åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æ›´æ–°æˆ–åˆ é™¤ç¼“å­˜ï¼Œéœ€æ±‚å¤šå˜çµæ´»è¿ç”¨ã€‚

## æ‰©å±•èµ„æ–™
> [ğŸ‘‰ç¤ºä¾‹æºç ](https://gitee.com/yl-yue/yue-library/tree/master/yue-library-samples/yue-library-test)<br>
> [ğŸ‘‰Redisç¼“å­˜é›ªå´©ã€å‡»ç©¿ã€ç©¿é€ã€é¢„çƒ­ã€é™çº§è¯¦è§£](https://mp.weixin.qq.com/s/O8eedi3X2TSeeUI6iWF-wA)