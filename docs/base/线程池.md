# çº¿ç¨‹æ± 
> æç¤ºï¼š`TaskExecutionAutoConfiguration` ä¸ºSpringBoot2.xæä¾›çš„å¼‚æ­¥ä»»åŠ¡çº¿ç¨‹æ± é…ç½®ç±»<br>
> æç¤ºï¼š`TaskSchedulingAutoConfiguration` ä¸ºSpringBoot2.xæä¾›çš„å®šæ—¶ä»»åŠ¡çº¿ç¨‹æ± é…ç½®ç±»

## å¼‚æ­¥ä»»åŠ¡
- å¼‚æ­¥ä¸€é”®å¼€å…³ï¼Œé…ç½®å¼€ç®±å³ç”¨
- æä¾›ç›¸å¯¹å¥å£®çš„é»˜è®¤é…ç½®ä¸æ›´ä¼˜é›…çš„å¼‚æ­¥çº¿ç¨‹æ± é…ç½®è¯´æ˜
- å®Œç¾è§£å†³ [å¼‚æ­¥ä¸Šä¸‹æ–‡](https://stackoverflow.com/questions/23732089/how-to-enable-request-scope-in-async-task-executor) é‡åˆ°çš„æ‰€æœ‰é—®é¢˜ï¼ˆåŒ…æ‹¬ï¼šå¹¶å‘æ¨¡å¼ ä¸ [Servletæå‰å…³é—­å¯¼è‡´çš„å­çº¿ç¨‹è·å–ä¸åˆ°å‚æ•°å¼‚å¸¸](https://blog.csdn.net/kid551/article/details/88703414)ï¼‰
- [ğŸ‘‰æ‰©å±•é˜…è¯»-çº¿ç¨‹é…ç½®è°ƒä¼˜](https://mp.weixin.qq.com/s/FI3EtlPirY3wHf73DExcag)

### å‚è€ƒé…ç½®
```java
yue: 
  thread-pool:
    async:
      enabled: true                                         # å¯ç”¨å¼‚æ­¥çº¿ç¨‹æ± 
      thread-name-prefix: async-exec-                       # çº¿ç¨‹æ± åçš„å‰ç¼€
      core-pool-size: 10                                    # æ ¸å¿ƒçº¿ç¨‹æ•°
      max-pool-size: 20                                     # æœ€å¤§çº¿ç¨‹æ•°
      queue-capacity: 200                                   # ä»»åŠ¡é˜Ÿåˆ—å®¹é‡ï¼ˆé˜»å¡é˜Ÿåˆ—ï¼‰
      allow-core-thread-time-out: false                     # æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶
      keep-alive-seconds: 60                                # å…è®¸çº¿ç¨‹çš„ç©ºé—²æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
      wait-for-tasks-to-complete-on-shutdown: true          # åº”ç”¨å…³é—­æ—¶-æ˜¯å¦ç­‰å¾…æœªå®Œæˆä»»åŠ¡ç»§ç»­æ‰§è¡Œï¼Œå†ç»§ç»­é”€æ¯å…¶ä»–çš„Bean
      await-termination-seconds: 5                          # åº”ç”¨å…³é—­æ—¶-ç»§ç»­ç­‰å¾…æ—¶é—´ï¼ˆå•ä½ï¼šç§’ï¼‰
      rejected-execution-handler-policy: caller_runs_policy # çº¿ç¨‹æ± æ‹’ç»ç­–ç•¥
      enable-servlet-async-context: true                    # æ˜¯å¦å¼€å¯ ServletAsyncContext
      servlet-async-context-timeout-millis: 600             # ServletAsyncContexté˜»å¡è¶…æ—¶æ—¶é•¿ï¼ˆå•ä½ï¼šæ¯«ç§’ï¼‰ï¼Œå¼‚æ­¥ä¸Šä¸‹æ–‡æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼ˆæœ€å¤§é˜»å¡çˆ¶çº¿ç¨‹å¤šä¹…ï¼‰
```

### çº¿ç¨‹è£…é¥°å™¨
webæ¨¡å—æä¾›äº†é»˜è®¤çš„çº¿ç¨‹è£…é¥°å™¨`ContextDecorator`ï¼Œå®ç°äº†Servletä¸Šä¸‹æ–‡ã€æ—¥å¿—ä¸Šä¸‹æ–‡ã€‚<br>
`ContextDecorator`æ˜¯ä¸€ä¸ªMissingBeanï¼Œå¯æ ¹æ®éœ€æ±‚é‡æ–°å®šä¹‰ï¼Œä½†åˆ«å¿˜è®°è°ƒç”¨`xxxServletAsyncContext`å¼€å¯å¼‚æ­¥ä¸Šä¸‹æ–‡ï¼Œç®€å•ç¤ºä¾‹ï¼š
```java
@Slf4j
@Component
public class CustomContextDecorator extends AbstractContextDecorator {

    public CustomContextDecorator(AsyncProperties asyncProperties) {
        super(asyncProperties);
    }

    @Override
    public Runnable decorate(Runnable runnable) {
        // æ·»åŠ è‡ªå·±çš„ä¸Šä¸‹æ–‡é€»è¾‘-è·å¾—å…¶å®ƒç¯å¢ƒä¸Šä¸‹æ–‡
		...
		
        // ServletAsyncContext-enableï¼šå¼‚æ­¥ä¸Šä¸‹æ–‡æœ€é•¿ç”Ÿå‘½å‘¨æœŸï¼ˆæœ€å¤§é˜»å¡çˆ¶çº¿ç¨‹å¤šä¹…ï¼‰
        ServletRequestAttributes context = ((ServletRequestAttributes) RequestContextHolder.getRequestAttributes());
        enableServletAsyncContext(context, asyncProperties);
        return () -> {
            try {
				// æ·»åŠ è‡ªå·±çš„ä¸Šä¸‹æ–‡é€»è¾‘-è®¾ç½®å…¶å®ƒç¯å¢ƒä¸Šä¸‹æ–‡
				...
				
				// ServletAsyncContext
                RequestContextHolder.setRequestAttributes(context);
                runnable.run();
            } finally {
				// æ·»åŠ è‡ªå·±çš„ä¸Šä¸‹æ–‡é€»è¾‘-é‡ç½®å…¶å®ƒç¯å¢ƒä¸Šä¸‹æ–‡
				...
				
                // ServletAsyncContext-completeï¼šå®Œæˆå¼‚æ­¥è¯·æ±‚å¤„ç†å¹¶å…³é—­å“åº”æµ
                RequestContextHolder.resetRequestAttributes();
                completeServletAsyncContext(context, asyncProperties);
            }
        };
    }

}
```

### å¼‚æ­¥ä½¿ç”¨ç¤ºä¾‹
```java
@Slf4j
@RestController
@RequestMapping("/async")
public class AsyncController {

    @Autowired
    AsyncService asyncService;

    @GetMapping("/async")
    public Result<?> async(JSONObject paramJson) {
        String asyncContext = ServletUtils.getRequest().getHeader("asyncContext");
        log.info("1. å¼‚æ­¥æµ‹è¯•-å¼€å§‹è°ƒç”¨å¼‚æ­¥æ–¹æ³•ï¼ŒasyncContextï¼š{}", asyncContext);
        asyncService.async(paramJson);
        log.info("2. å¼‚æ­¥æµ‹è¯•-å¼‚æ­¥æ–¹æ³•æ­£åœ¨æ‰§è¡Œ");
        return R.success();
    }
	
}
```

```java
@Slf4j
@Service
public class AsyncService {

    @Autowired
    PersonDAO personDAO;

    @Async
    public void async(JSONObject paramJson) {
        HttpServletRequest request = ServletUtils.getRequest();
        log.info("3. asyncContext: {}", request.getHeader("asyncContext"));
        PageVO<PersonDO> pageTVO = personDAO.page(PageIPO.parsePageIPO(paramJson));
        log.info("4. å¼‚æ­¥æµ‹è¯•-å¼‚æ­¥æ–¹æ³•æ‰§è¡Œå®Œæ¯•ï¼Œåˆ†é¡µæ•°æ®å¤§å°ï¼š{}", pageTVO.getCount());
        HttpServletRequest request2 = ServletUtils.getRequest();
        log.info("5. asyncContext: {}", request2.getHeader("asyncContext"));
    }

}
```

## å®šæ—¶ä»»åŠ¡
å¾…è¡¥å……ï¼Œå¯æœç´¢SpringBootå®šæ—¶ä»»åŠ¡ï¼Œå†åˆ†å¸ƒå¼åœºæ™¯ä¸‹ï¼Œæ¨èä½¿ç”¨XXL-JOB